<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Drug Tracker</title>
  <meta name="description" content="Track drug dosage and timing easily on any device">
  <style>
    :root {
      --bg: #0b1020;
      --card: #121731;
      --card-2: #161c3e;
      --text: #e7ecff;
      --muted: #b9c0e6;
      --accent: #4f7cff;
      --accent-2: #8ea8ff;
      --ok: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
      --grid-gap: 16px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    html { -webkit-text-size-adjust: 100%; }
    input, select, textarea, .edit-input { font-size: 16px; }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1200px 700px at 10% -10%, #1b2350 0, transparent 60%),
                  radial-gradient(800px 500px at 90% -10%, #1a255a 0, transparent 60%),
                  var(--bg);
    }

    .container { max-width: 1100px; margin: 40px auto; padding: 24px; position: relative; }

    header { position: relative; padding-right: 140px; margin-bottom: 20px; }
    header h1 { font-size: clamp(22px, 3vw, 32px); margin: 0 0 6px; letter-spacing: 0.3px; }
    header p { margin: 0; color: var(--muted); }

    .reset-all-btn {
      position: absolute; top: 0; right: 0;
      padding: 8px 12px; font-size: 13px; font-weight: 600;
      background: rgba(239, 68, 68, 0.15); color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 10px;
      cursor: pointer; transition: background 0.2s;
    }
    .reset-all-btn:hover { background: rgba(239, 68, 68, 0.25); }

    .inline-link {
      background: transparent; border: 0; padding: 0; margin-left: 6px; color: var(--muted);
      text-decoration: underline; font-weight: 500; cursor: pointer;
    }
    .inline-link:hover { text-decoration: none; }

    .toolbar { display: flex; gap: 8px; margin-bottom: 16px; align-items: center; }
    .toolbar button { padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: var(--text); cursor: pointer; }
    .toolbar button:hover { background: rgba(255,255,255,0.12); }

    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--grid-gap); }

    /* --- Card Styles --- */
    .card {
      background: linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    /* Collapsed State Styles */
    .card.collapsed {
      cursor: pointer;
      gap: 4px; /* Tighter spacing when collapsed */
      padding-bottom: 14px;
    }
    .card.collapsed:hover {
      transform: translateY(-2px);
      background: linear-gradient(180deg, var(--card-2) 0%, var(--card) 100%);
    }
    .card.collapsed .expanded-content {
      display: none;
    }
    /* When collapsed, the name shouldn't capture clicks so the card can expand */
    .card.collapsed .name {
      pointer-events: none;
    }

    .color-strip { position: absolute; inset: 0 0 auto 0; height: 4px; border-radius: var(--radius) var(--radius) 0 0; }

    .card-header {
      display: flex; flex-direction: column; gap: 4px;
    }

    /* Remove button only visible in expanded */
    .remove { 
      position: absolute; right: 10px; top: 10px; padding: 4px 8px; font-size: 12px; 
      border-radius: 8px; border: 1px solid rgba(255,255,255,0.12); 
      background: rgba(255,255,255,0.06); color: var(--text); cursor: pointer; z-index: 2;
    }
    .remove:hover { background: rgba(255,255,255,0.12); }

    .name { 
      font-size: 18px; font-weight: 700; letter-spacing: .4px; 
      margin: 6px 0 2px 0; padding: 2px 6px; border-radius: 8px; outline: none;
      width: fit-content; max-width: 100%;
    }
    .card.expanded .name { margin-right: 60px; } /* Space for remove button */
    
    .name[contenteditable="true"]:focus { box-shadow: 0 0 0 4px rgba(79, 124, 255, 0.25); background: rgba(255,255,255,0.06); }
    .name.invalid { box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.35) !important; }
    .name-error { color: var(--danger); font-size: 12px; margin: 0 0 6px 0; display: none; }

    /* Meta info (Total/Last) - Visible in both, styled slightly differently */
    .meta { 
      font-size: 13px; color: var(--muted); display: flex; flex-direction: column; gap: 2px; 
    }
    .card.collapsed .meta {
      margin-top: 4px;
      font-size: 13px;
      opacity: 0.8;
    }
    
    /* Expanded Content Wrapper */
    .expanded-content {
      display: flex; flex-direction: column; gap: 12px;
      animation: fadeIn 0.2s ease;
    }

    /* Color picker */
    .color-picker { position: relative; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-top: 4px; }
    .color-picker label { font-size: 12px; color: var(--muted); }
    .color-select-btn { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: var(--text); cursor: pointer; }
    .color-select-btn .swatch { width: 14px; height: 14px; border-radius: 999px; background: var(--swatch, #8ea8ff); box-shadow: 0 0 0 1px rgba(255,255,255,0.2) inset; }
    .color-menu { position: absolute; top: calc(100% + 6px); left: 0; min-width: 220px; background: linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 8px; box-shadow: var(--shadow); display: none; z-index: 200; }
    .color-picker.open .color-menu { display: grid; grid-template-columns: 1fr; gap: 6px; }
    .color-option { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.04); cursor: pointer; }
    .color-option:hover { background: rgba(255,255,255,0.10); }
    .color-option .swatch { width: 14px; height: 14px; border-radius: 999px; background: var(--swatch); }

    /* Input Styling */
    input[type="text"], input[type="datetime-local"], input[type="number"], select { width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: var(--text); outline: none; transition: border-color .15s ease, background .15s ease; }
    input[type="text"]:focus, input[type="number"]:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(79, 124, 255, 0.25); background: rgba(255,255,255,0.1); }
    input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    
    .dose-grid { display: grid; grid-template-columns: 1fr 100px auto; gap: 8px; }

    button.add-btn { padding: 12px 14px; border: 1px solid rgba(255,255,255,0.12); background: rgba(79, 124, 255, 0.15); color: var(--text); border-radius: 10px; cursor: pointer; font-weight: 600; transition: background .15s ease; }
    button.add-btn:hover { background: rgba(79, 124, 255, 0.25); }

    /* New "Last Dose" Button */
    button.add-last-btn {
      width: 100%; padding: 8px; margin-top: 0;
      font-size: 13px; font-weight: 500;
      background: transparent; border: 1px dashed rgba(255,255,255,0.15);
      color: var(--muted); border-radius: 8px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    button.add-last-btn:hover { background: rgba(255,255,255,0.04); color: var(--text); border-color: rgba(255,255,255,0.3); }
    button.add-last-btn.hidden { display: none; }

    /* Log Table */
    .log { margin-top: 26px; background: linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%); border: 1px solid rgba(255,255,255,0.06); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
    .log-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .log-header h3 { margin: 0; font-size: 15px; letter-spacing: 0.3px; }
    .controls button { padding: 8px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: var(--text); cursor: pointer; font-size: 12px; }
    
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    thead th { text-align: left; padding: 10px 14px; color: var(--muted); font-weight: 600; border-bottom: 1px solid rgba(255,255,255,0.06); }
    tbody td { padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,0.06); vertical-align: middle; }
    tbody tr:last-child td { border-bottom: none; }
    .empty-row td { text-align: center; color: var(--muted); padding: 18px; }
    .date-row td { background: rgba(255,255,255,0.04); color: var(--accent-2); font-weight: 700; letter-spacing: .3px; }
    
    .row-actions { white-space: nowrap; text-align: right; }
    .icon-btn { border: none; background: transparent; color: var(--muted); cursor: pointer; font-size: 16px; padding: 4px 6px; }
    .icon-btn:hover { color: var(--text); }
    .icon-danger:hover { color: var(--danger); }

    .drug-chip { display: inline-flex; align-items: center; gap: 8px; padding: 4px 10px; border-radius: 999px; font-weight: 600; border: 1px solid rgba(255,255,255,0.12); }
    .drug-chip .dot { width: 10px; height: 10px; border-radius: 999px; background: var(--dot, #8ea8ff); }
    
    /* Snackbar */
    .snackbar { position: fixed; left: 50%; bottom: calc(24px + var(--safe-bottom)); transform: translateX(-50%); background: #151a35; color: var(--text); border: 1px solid rgba(255,255,255,0.12); border-radius: 12px; padding: 10px 14px; box-shadow: var(--shadow); display: none; z-index: 1000; }
    .snackbar.show { display: inline-flex; }

    /* Modals */
    .modal-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(6, 10, 30, 0.6); backdrop-filter: blur(2px); z-index: 1100; }
    .modal-overlay.show { display: flex; }
    .modal { width: min(92vw, 520px); max-height: 80vh; overflow: auto; background: linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%); border: 1px solid rgba(255,255,255,0.10); border-radius: 16px; box-shadow: var(--shadow); padding: 18px; animation: slideIn .18s ease forwards; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(8px) } to { opacity: 1; transform: translateY(0) } }
    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
    .modal h4 { margin: 0 0 6px; font-size: 16px; }
    .modal p { margin: 0 0 14px; color: var(--muted); }
    .modal .actions { display: flex; gap: 8px; justify-content: flex-end; }
    .btn { padding: 10px 12px; border-radius: 10px; font-weight: 600; cursor: pointer; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: var(--text); }
    .btn-danger { background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.35); }
    .btn-ghost { background: transparent; border-color: rgba(255,255,255,0.15); }

    /* History Floating Button */
    .history-fab { position: fixed; left: 16px; bottom: calc(16px + var(--safe-bottom)); padding: 12px 16px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.08); color: var(--text); font-weight: 700; cursor: pointer; z-index: 1050; backdrop-filter: blur(5px); }
    .history-list { display: grid; gap: 10px; }
    .history-item { display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; padding: 10px; border-radius: 12px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); }
    .drug-pill { display: inline-flex; align-items: center; gap: 8px; }
    .drug-pill .color-dot { width: 10px; height: 10px; border-radius: 999px; }

    /* Mobile optimizations */
    @media (max-width: 960px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 720px) {
      .container { padding: 16px; margin: 20px auto; }
      header { padding-right: 0; display: flex; flex-direction: column; gap: 10px; }
      .reset-all-btn { position: static; width: fit-content; }
      .grid { grid-template-columns: 1fr; gap: 12px; }
      .dose-grid { grid-template-columns: 1fr 80px auto; }
      /* Table optimizations */
      thead th:nth-child(3), tbody td:nth-child(3) { display: none; } /* Hide "Doses" col on mobile */
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Drug Tracker</h1>
        <p>Track drug dosage and timing.<a href="#" id="privacy-open" class="inline-link">Privacy</a></p>
      </div>
      <button id="reset-all" class="reset-all-btn">Reset Everything</button>
    </header>

    <div class="toolbar">
      <button id="add-med">+ Add Drug Category</button>
    </div>

    <section class="grid" id="drug-grid" aria-label="Drug Inputs"></section>

    <section class="log" aria-label="Total Drug Intake">
      <div class="log-header">
        <h3>Total Drug Intake</h3>
        <div class="controls">
          <button id="clear-log" title="Clear all entries">Clear Entries</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Drug</th>
            <th>Total</th>
            <th>Doses</th>
            <th>Time</th>
            <th style="width:72px"></th>
          </tr>
        </thead>
        <tbody id="log-body">
          <tr class="empty-row"><td colspan="5">No entries yet.</td></tr>
        </tbody>
      </table>
    </section>
  </div>

  <button id="open-history" class="history-fab">View History</button>

  <div id="snackbar" class="snackbar"><span id="snackbar-msg"></span></div>

  <div id="confirm" class="modal-overlay">
    <div class="modal">
      <h4 id="confirm-title">Confirm</h4>
      <p id="confirm-msg">Proceed?</p>
      <div class="actions">
        <button class="btn btn-ghost" id="confirm-no">No</button>
        <button class="btn btn-danger" id="confirm-yes">Yes</button>
      </div>
    </div>
  </div>

  <div id="history" class="modal-overlay">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h4 style="margin:0;">History</h4>
        <div class="actions">
          <button class="btn btn-ghost" id="history-close">Close</button>
          <button class="btn btn-danger" id="history-clear">Clear</button>
        </div>
      </div>
      <p style="margin-top:8px;">Includes removed entries.</p>
      <div id="history-list" class="history-list"></div>
    </div>
  </div>

  <div id="privacy" class="modal-overlay">
    <div class="modal">
      <h4>Privacy</h4>
      <p>Data is stored locally on your device.</p>
      <div class="actions"><button class="btn btn-ghost" id="privacy-close">Close</button></div>
    </div>
  </div>

  <script>
    // --- Utilities ---
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function deepClone(obj) {
      if (typeof structuredClone === 'function') return structuredClone(obj);
      return JSON.parse(JSON.stringify(obj));
    }

    function timeStr(d) {
      try { return new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit' }).format(d); }
      catch { return d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}); }
    }
    function dateLabel(d) {
      const pad = (n) => String(n).padStart(2, '0');
      return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.`;
    }
    function dayKey(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function fmtNumber(n) { return (Math.round(n*1000)/1000).toString(); }
    function uid(prefix='id') { return `${prefix}_${Math.random().toString(36).slice(2,9)}_${Date.now().toString(36)}`; }
    function nameKey(str) { return (str || '').toString().trim().toLowerCase(); }
    function hexToRgba(hex, a = 1) {
      const v = (hex || '').replace('#','');
      const r = parseInt(v.substring(0,2),16) || 0;
      const g = parseInt(v.substring(2,4),16) || 0;
      const b = parseInt(v.substring(4,6),16) || 0;
      return `rgba(${r},${g},${b},${a})`;
    }

    // --- Data & Config ---
    function normalizeUnit(unitRaw) {
      if (!unitRaw) return '';
      const token = unitRaw.trim().toLowerCase();
      if (token === 'ml') return 'mL';
      if (token === 'l') return 'L';
      if (['ug','mcg','µg'].includes(token)) return 'µg';
      return token;
    }

    const PLURALS = { pill: ['pill', 'pills'], tab: ['tab', 'tabs'], line: ['line', 'lines'], drop: ['drop', 'drops'], unit: ['unit', 'units'] };
    function displayValueUnit(value, unit) {
      if (!unit) return fmtNumber(value);
      const uCanon = normalizeUnit(unit);
      const p = PLURALS[uCanon];
      if (p) { const u = (value === 1) ? p[0] : p[1]; return `${fmtNumber(value)} ${u}`; }
      return `${fmtNumber(value)} ${uCanon}`;
    }

    const UNIT_OPTIONS = [
      { value: 'mg', label: 'mg' }, { value: 'g', label: 'g' }, { value: 'µg', label: 'µg' },
      { value: 'pill', label: 'pill' }, { value: 'tab', label: 'tab' },
      { value: 'line', label: 'line' }, { value: 'unit', label: 'unit' },
      { value: 'ml', label: 'ml' }, { value: 'l', label: 'l' }, { value: 'drop', label: 'drop' }
    ];

    const palette = ['#ef4444','#f59e0b','#eab308','#84cc16','#22c55e','#10b981','#06b6d4','#3b82f6','#8b5cf6','#ec4899'];
    const paletteNames = ['Red','Orange','Yellow','Lime','Green','Teal','Cyan','Blue','Violet','Pink'];

    // --- State ---
    const initialState = { drugs: [], entries: [], history: [] };
    const STORAGE_KEY = 'med_tracker_v2_state';
    
    // UI State: Track which cards are expanded
    const expandedCards = new Set();

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return deepClone(initialState);
        const parsed = JSON.parse(raw);
        parsed.entries?.forEach(e => e.ts = new Date(e.ts));
        parsed.history?.forEach(h => { h.ts = new Date(h.ts); if (h.addedAt) h.addedAt = new Date(h.addedAt); if (h.removedAt) h.removedAt = new Date(h.removedAt); });
        if (!Array.isArray(parsed.drugs)) parsed.drugs = [];
        if (!Array.isArray(parsed.entries)) parsed.entries = [];
        if (!Array.isArray(parsed.history)) parsed.history = [];
        parsed.drugs.forEach((d, i) => { if (!d.color) d.color = palette[i % palette.length]; });
        return parsed;
      } catch (e) {
        return deepClone(initialState);
      }
    }

    let state = loadState();
    function saveState() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch {} }

    function lastDoseDate(drugId) {
      let latest = null;
      for (const e of state.entries) {
        if (e.drugId !== drugId) continue;
        if (!latest || e.ts > latest) latest = e.ts;
      }
      return latest;
    }
    
    function getLastEntry(drugId) {
        const relevant = state.entries.filter(e => e.drugId === drugId);
        if (!relevant.length) return null;
        return relevant.sort((a,b) => b.ts - a.ts)[0];
    }

    // --- UI Rendering ---
    const grid = $('#drug-grid');
    const logBody = $('#log-body');

    function render() { 
        renderDrugs(); 
        renderLog(); 
        updateLastDoseLabels(); 
    }

    function renderDrugs() {
      grid.innerHTML = '';
      
      const sortedDrugs = [...state.drugs].sort((a, b) => {
        const lastA = lastDoseDate(a.id) || 0;
        const lastB = lastDoseDate(b.id) || 0;
        if (lastA === 0 && lastB === 0) return 0; 
        return lastB - lastA;
      });

      sortedDrugs.forEach((drug) => {
        const isExpanded = expandedCards.has(drug.id);
        
        const card = document.createElement('div');
        card.className = `card ${isExpanded ? 'expanded' : 'collapsed'}`;
        card.dataset.id = drug.id;

        // Background click listener for expansion
        card.addEventListener('click', (e) => {
            // If user clicks interactive elements, do not toggle
            if (e.target.closest('input, select, button, .color-option, .color-select-btn')) return;
            // If collapsed, expand
            if (!expandedCards.has(drug.id)) {
                expandedCards.add(drug.id);
                render(); // Re-render to show content
            } else {
                // If expanded and clicking header area (not input), collapse
                // But we need to be careful not to collapse when editing name
                if (e.target.closest('.card-header') && e.target !== card.querySelector('.name')) {
                    expandedCards.delete(drug.id);
                    render();
                }
            }
        });

        const strip = document.createElement('div');
        strip.className = 'color-strip';
        strip.style.background = drug.color;
        card.appendChild(strip);

        // --- Header Section (Visible Always) ---
        const header = document.createElement('div');
        header.className = 'card-header';

        // Name
        const nameEl = document.createElement('h2');
        nameEl.className = 'name';
        nameEl.textContent = drug.name;
        
        if (isExpanded) {
            nameEl.contentEditable = 'true';
            nameEl.spellcheck = false;
            // Prevent collapse when clicking the editable name
            nameEl.addEventListener('click', (e) => e.stopPropagation());
            
            nameEl.dataset.prev = drug.name;
            nameEl.setAttribute('enterkeyhint', 'done');
            
            const nameErr = document.createElement('div');
            nameErr.className = 'name-error';
            nameErr.textContent = 'Name taken';

            nameEl.addEventListener('keydown', (e) => { 
               if (e.key === 'Enter') { e.preventDefault(); nameEl.blur(); } 
            });
            
            nameEl.addEventListener('input', () => {
                const proposed = nameEl.textContent.trim();
                const dup = state.drugs.some(d => d.id !== drug.id && nameKey(d.name) === nameKey(proposed));
                if (dup) { nameEl.classList.add('invalid'); nameErr.style.display = 'block'; }
                else { nameEl.classList.remove('invalid'); nameErr.style.display = 'none'; }
            });
            
            nameEl.addEventListener('blur', () => {
                const proposed = nameEl.textContent.trim();
                const dup = state.drugs.some(d => d.id !== drug.id && nameKey(d.name) === nameKey(proposed));
                if (!proposed.length || dup) {
                    nameEl.textContent = drug.name;
                    nameEl.classList.remove('invalid');
                    nameErr.style.display = 'none';
                    return;
                }
                drug.name = proposed;
                saveState();
            });
            
            header.appendChild(nameErr);
        }
        header.appendChild(nameEl);

        // Meta (Total / Last Dose)
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.id = `meta-${drug.id}`;
        
        const totalSpan = document.createElement('span');
        totalSpan.id = `meta-total-${drug.id}`;
        totalSpan.textContent = totalsForDrugLabel(drug.id);
        
        const lastSpan = document.createElement('span');
        lastSpan.id = `last-${drug.id}`;
        lastSpan.textContent = 'Last Dose: —'; // Updated via interval
        
        meta.appendChild(totalSpan);
        meta.appendChild(lastSpan);
        header.appendChild(meta);
        
        card.appendChild(header);

        // --- Expanded Content (Hidden if collapsed) ---
        if (isExpanded) {
            const expandedContent = document.createElement('div');
            expandedContent.className = 'expanded-content';

            // Remove Button
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove';
            removeBtn.textContent = 'Remove';
            removeBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const ok = await openConfirm(`Remove category "${drug.name}"?`);
                if (ok) { removeDrug(drug.id); showToast('Category removed.'); }
            });
            card.appendChild(removeBtn); // Absolute positioned in card

            // Dose Inputs
            const doseRow = document.createElement('div');
            doseRow.className = 'dose-grid';
            
            const numInput = document.createElement('input');
            numInput.type = 'number';
            numInput.step = 'any';
            numInput.placeholder = '0';
            numInput.min = '0';
            numInput.setAttribute('inputmode', 'decimal');
            
            const unitSelect = document.createElement('select');
            for (const u of UNIT_OPTIONS) {
                const opt = document.createElement('option');
                opt.value = u.value; opt.textContent = u.label; unitSelect.appendChild(opt);
            }
            unitSelect.value = drug.lastUnit || 'mg';
            
            const addBtn = document.createElement('button');
            addBtn.className = 'add-btn';
            addBtn.textContent = 'Add';
            const onAdd = () => addEntryStandard(drug.id, drug.name, numInput, unitSelect, drug.color);
            addBtn.addEventListener('click', onAdd);
            numInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); onAdd(); } });
            
            doseRow.appendChild(numInput);
            doseRow.appendChild(unitSelect);
            doseRow.appendChild(addBtn);
            expandedContent.appendChild(doseRow);

            // "Add Last Dose" Button
            const lastEntry = getLastEntry(drug.id);
            const repeatBtn = document.createElement('button');
            repeatBtn.className = 'add-last-btn';
            if (lastEntry) {
                repeatBtn.innerHTML = `<span>↻</span> Repeat Last: <strong>${lastEntry.dosageText}</strong>`;
                repeatBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    addEntryDirect(drug.id, drug.name, lastEntry.value, lastEntry.unitRaw || lastEntry.unit, drug.color);
                    showToast(`Added ${lastEntry.dosageText}`);
                });
            } else {
                repeatBtn.classList.add('hidden');
            }
            expandedContent.appendChild(repeatBtn);

            // Color Picker
            const colorWrap = document.createElement('div');
            colorWrap.className = 'color-picker';
            const colorLabel = document.createElement('label');
            colorLabel.textContent = 'Color:';
            const colorBtn = document.createElement('button');
            colorBtn.className = 'color-select-btn';
            colorBtn.style.setProperty('--swatch', drug.color);
            colorBtn.innerHTML = `<span class="swatch"></span><span class="label">${paletteNames[palette.indexOf(drug.color)]||'Color'}</span>`;
            
            const menu = document.createElement('div');
            menu.className = 'color-menu';
            palette.forEach((hex, i) => {
                const opt = document.createElement('div');
                opt.className = 'color-option';
                opt.innerHTML = `<span class="swatch" style="--swatch:${hex}"></span><span class="label">${paletteNames[i]}</span>`;
                opt.addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    drug.color = hex;
                    saveState(); render();
                });
                menu.appendChild(opt);
            });
            
            colorBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                colorWrap.classList.toggle('open');
            });
            
            colorWrap.appendChild(colorLabel);
            colorWrap.appendChild(colorBtn);
            colorWrap.appendChild(menu);
            expandedContent.appendChild(colorWrap);

            card.appendChild(expandedContent);
        }

        grid.appendChild(card);
      });
    }

    document.addEventListener('click', () => { $$('.color-picker.open').forEach(el => el.classList.remove('open')); });

    function renderLog() {
      const entries = [...state.entries].sort((a,b) => b.ts - a.ts);
      logBody.innerHTML = '';
      if (!entries.length) {
        logBody.innerHTML = '<tr class="empty-row"><td colspan="5">No entries yet.</td></tr>';
        return;
      }

      // Calculate daily groups
      const groups = {};
      entries.forEach(e => { 
          const k = dayKey(e.ts); 
          if (!groups[k]) groups[k] = []; 
          groups[k].push(e); 
      });
      
      const dayKeys = Object.keys(groups).sort((a,b) => (a<b?1:-1));

      for (const dk of dayKeys) {
        const d = new Date(dk + 'T00:00:00');
        const trDate = document.createElement('tr');
        trDate.className = 'date-row';
        trDate.innerHTML = `<td colspan="5">${dateLabel(d)}</td>`;
        logBody.appendChild(trDate);

        groups[dk].forEach(e => {
            const tr = document.createElement('tr');
            const drugName = state.drugs.find(d=>d.id===e.drugId)?.name || e.drugNameAtEntry || 'Drug';
            const color = state.drugs.find(d=>d.id===e.drugId)?.color || e.colorAtEntry || '#8ea8ff';
            
            const tdName = document.createElement('td');
            tdName.innerHTML = `<span class="drug-chip" style="background:${hexToRgba(color,0.15)};border-color:${hexToRgba(color,0.3)}"><span class="dot" style="--dot:${color}"></span>${drugName}</span>`;
            
            const tdTotal = document.createElement('td');
            // Calculate global total for this entry context? For now simplified
            tdTotal.textContent = '—'; 
            
            const tdDose = document.createElement('td');
            tdDose.textContent = e.dosageText;
            
            const tdTime = document.createElement('td');
            tdTime.textContent = timeStr(e.ts);
            
            const tdAct = document.createElement('td');
            tdAct.className = 'row-actions';
            
            const delBtn = document.createElement('button');
            delBtn.className = 'icon-btn icon-danger';
            delBtn.textContent = '×';
            delBtn.onclick = async () => {
                const ok = await openConfirm('Remove entry?');
                if(ok) {
                    state.entries = state.entries.filter(x => x.id !== e.id);
                    state.history.find(h => h.id === e.id && (h.removed=true));
                    saveState(); render();
                    showToast('Entry removed');
                }
            };
            
            tdAct.appendChild(delBtn);
            
            tr.appendChild(tdName);
            tr.appendChild(tdTotal);
            tr.appendChild(tdDose);
            tr.appendChild(tdTime);
            tr.appendChild(tdAct);
            logBody.appendChild(tr);
        });
      }
    }

    function totalsForDrugLabel(drugId) {
      const units = new Map();
      for (const e of state.entries) {
        if (e.drugId !== drugId) continue;
        const u = normalizeUnit(e.unit || '');
        units.set(u, (units.get(u) || 0) + e.value);
      }
      if (!units.size) return 'Total: —';
      const parts = [];
      for (const [unit, sum] of units.entries()) { parts.push(displayValueUnit(sum, unit)); }
      return `Total: ${parts.join(' • ')}`;
    }

    function updateLastDoseLabels() {
      state.drugs.forEach(d => {
        const el = document.getElementById(`last-${d.id}`);
        if (!el) return;
        const date = lastDoseDate(d.id);
        if (!date) { el.textContent = 'Last Dose: —'; return; }
        
        const diff = (new Date() - date) / 60000; // mins
        let txt = '';
        if (diff < 1) txt = 'just now';
        else if (diff < 60) txt = `${Math.floor(diff)}min ago`;
        else if (diff < 1440) txt = `${Math.floor(diff/60)}h ${Math.floor(diff%60)}min ago`;
        else txt = `${Math.floor(diff/1440)}d ${Math.floor((diff%1440)/60)}h ago`;
        el.textContent = `Last Dose: ${txt}`;
      });
    }

    // --- Actions ---
    function addEntryStandard(drugId, name, input, select, color) {
        const val = parseFloat(input.value);
        if (!val || val <= 0) { showToast('Invalid amount'); return; }
        addEntryDirect(drugId, name, val, select.value, color);
        input.value = '';
    }

    function addEntryDirect(drugId, name, val, unitRaw, color) {
        const unit = normalizeUnit(unitRaw);
        const entry = { 
            id: uid('e'), ts: new Date(), 
            drugId, drugNameAtEntry: name, 
            value: val, unit, unitRaw, 
            dosageText: displayValueUnit(val, unitRaw) 
        };
        state.entries.push(entry);
        state.history.push({ ...entry, colorAtEntry: color, removed: false });
        
        const drug = state.drugs.find(d=>d.id === drugId);
        if(drug) drug.lastUnit = unitRaw;
        
        saveState(); render();
    }

    function removeDrug(id) {
        state.drugs = state.drugs.filter(d => d.id !== id);
        expandedCards.delete(id);
        saveState(); render();
    }

    // --- Event Listeners ---
    $('#add-med').addEventListener('click', () => {
        let i = state.drugs.length + 1;
        let base = 'Drug ';
        let name = base + i;
        while(state.drugs.some(d=>nameKey(d.name)===nameKey(name))) { i++; name = base + i; }
        
        const newId = uid('drug');
        state.drugs.push({ id: newId, name, color: palette[state.drugs.length % palette.length] });
        expandedCards.add(newId); // Auto-expand new drug
        saveState();
        render();
        
        // Focus the new name field
        setTimeout(() => {
            const card = document.querySelector(`.card[data-id="${newId}"]`);
            const nameField = card?.querySelector('.name');
            if(nameField) {
                nameField.focus();
                // Select all text for easy overwrite
                const range = document.createRange();
                range.selectNodeContents(nameField);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }, 50);
    });

    $('#reset-all').addEventListener('click', async () => {
        if (await openConfirm('Reset everything?')) {
            state = deepClone(initialState);
            expandedCards.clear();
            saveState(); render();
            showToast('Reset complete');
        }
    });

    $('#clear-log').addEventListener('click', async () => {
        if(state.entries.length && await openConfirm('Clear current log?')) {
            state.entries = [];
            saveState(); render();
            showToast('Log cleared');
        }
    });

    // --- Modals & Confirm ---
    const confirmOverlay = $('#confirm');
    let confirmResolver = null;
    function openConfirm(msg) {
        $('#confirm-msg').textContent = msg;
        confirmOverlay.classList.add('show');
        $('#confirm-no').focus();
        return new Promise(r => confirmResolver = r);
    }
    $('#confirm-yes').onclick = () => { confirmOverlay.classList.remove('show'); confirmResolver && confirmResolver(true); };
    $('#confirm-no').onclick = () => { confirmOverlay.classList.remove('show'); confirmResolver && confirmResolver(false); };

    // History
    $('#open-history').onclick = () => {
        const list = $('#history-list');
        list.innerHTML = '';
        [...state.history].sort((a,b)=>b.ts-a.ts).forEach(h => {
            const d = document.createElement('div');
            d.className = 'history-item';
            d.innerHTML = `
                <div class="drug-pill"><span class="color-dot" style="background:${h.colorAtEntry||'#888'}"></span><b>${h.drugNameAtEntry}</b></div>
                <div>${h.dosageText}<div style="font-size:12px;color:#888">${dateLabel(h.ts)}, ${timeStr(h.ts)}</div></div>
                <div style="font-size:12px;color:${h.removed?'#ef4444':'#22c55e'}">${h.removed?'Removed':'Active'}</div>
            `;
            list.appendChild(d);
        });
        $('#history').classList.add('show');
    };
    $('#history-close').onclick = () => $('#history').classList.remove('show');
    $('#history-clear').onclick = async () => {
        if(await openConfirm('Clear history?')) { state.history=[]; saveState(); $('#history').classList.remove('show'); }
    };

    // Privacy
    $('#privacy-open').onclick = (e) => { e.preventDefault(); $('#privacy').classList.add('show'); };
    $('#privacy-close').onclick = () => $('#privacy').classList.remove('show');

    // Snackbar
    const snack = $('#snackbar');
    let snackTimer;
    function showToast(msg) {
        $('#snackbar-msg').textContent = msg;
        snack.classList.add('show');
        clearTimeout(snackTimer);
        snackTimer = setTimeout(() => snack.classList.remove('show'), 2500);
    }

    setInterval(updateLastDoseLabels, 60000);
    render();
  </script>
</body>
</html>
