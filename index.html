<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Drug Tracker</title>
  <meta name="description" content="Track drug dosage and timing easily on any device">
  <meta property="og:title" content="Drug Tracker">
  <meta property="og:description" content="Track drug dosage and timing easily on any device">
  <style>
    :root {
      --bg: #0b1020;
      --card: #121731;
      --card-2: #161c3e;
      --text: #e7ecff;
      --muted: #b9c0e6;
      --accent: #4f7cff;
      --accent-2: #8ea8ff;
      --ok: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
      --grid-gap: 16px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    html { -webkit-text-size-adjust: 100%; }
    input, select, textarea, .edit-input { font-size: 16px; }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1200px 700px at 10% -10%, #1b2350 0, transparent 60%),
                  radial-gradient(800px 500px at 90% -10%, #1a255a 0, transparent 60%),
                  var(--bg);
    }

    .container { max-width: 1100px; margin: 40px auto; padding: 24px; }

    header h1 { font-size: clamp(22px, 3vw, 32px); margin: 0 0 6px; letter-spacing: 0.3px; }
    header p { margin: 0 0 18px; color: var(--muted); }

    .inline-link {
      background: transparent;
      border: 0;
      padding: 0;
      margin-left: 6px;
      color: var(--muted);
      text-decoration: underline;
      font-weight: 500;      /* regular link weight */
      cursor: pointer;
    }
    .inline-link:hover { text-decoration: none; }
    .inline-link:focus-visible {
      outline: 2px solid var(--accent-2);
      outline-offset: 2px;
      border-radius: 2px;
    }

    .toolbar { display: flex; gap: 8px; margin-bottom: 16px; align-items: center; }
    .toolbar button { padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: var(--text); cursor: pointer; }
    .toolbar button:hover { background: rgba(255,255,255,0.12); }

    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--grid-gap); }

    .card {
      background: linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .color-strip { position: absolute; inset: 0 0 auto 0; height: 4px; border-radius: var(--radius) var(--radius) 0 0; }

    .card .remove { position: absolute; right: 10px; top: 10px; padding: 4px 8px; font-size: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: var(--text); cursor: pointer; }
    .card .remove:hover { background: rgba(255,255,255,0.12); }

    .name { font-size: 16px; font-weight: 800; letter-spacing: .4px; margin: 0 72px 2px 0; padding: 2px 6px; border-radius: 8px; outline: none; }
    .name[contenteditable="true"]:focus { box-shadow: 0 0 0 4px rgba(79, 124, 255, 0.25); background: rgba(255,255,255,0.06); }
    .name.invalid { box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.35) !important; }

    .name-row { display: flex; align-items: center; gap: 8px; }
    .name-error { color: var(--danger); font-size: 12px; margin: 0 0 6px 0; display: none; }

    /* Color picker (custom dropdown) */
    .color-picker { position: relative; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .color-picker label { font-size: 12px; color: var(--muted); }
    .color-select-btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: var(--text); cursor: pointer; }
    .color-select-btn:hover { background: rgba(255,255,255,0.12); }
    .color-select-btn .swatch { width: 14px; height: 14px; border-radius: 999px; background: var(--swatch, #8ea8ff); box-shadow: 0 0 0 1px rgba(255,255,255,0.2) inset; }
    .color-menu { position: absolute; top: calc(100% + 6px); left: 0; min-width: 220px; background: linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 8px; box-shadow: var(--shadow); display: none; z-index: 200; }
    .color-picker.open .color-menu { display: grid; grid-template-columns: 1fr; gap: 6px; }
    .color-option { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.04); cursor: pointer; }
    .color-option:hover { background: rgba(255,255,255,0.10); }
    .color-option .swatch { width: 14px; height: 14px; border-radius: 999px; background: var(--swatch); box-shadow: 0 0 0 1px rgba(255,255,255,0.2) inset; }
    .color-option .label { font-size: 14px; }

    .input-row { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }

    input[type="text"], input[type="datetime-local"], input[type="number"], select { width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: var(--text); outline: none; transition: border-color .15s ease, background .15s ease, box-shadow .15s ease; }
    input[type="text"]::placeholder { color: #9aa4d3; }
    input[type="text"]:focus, input[type="datetime-local"]:focus, input[type="number"]:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(79, 124, 255, 0.25); background: rgba(255,255,255,0.1); }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }

    .dose-grid { display: grid; grid-template-columns: 1fr 140px auto; gap: 8px; }

    button.add-btn { padding: 12px 14px; border: 1px solid rgba(255,255,255,0.12); background: rgba(79, 124, 255, 0.15); color: var(--text); border-radius: 10px; cursor: pointer; font-weight: 600; transition: background .15s ease, transform .05s ease; }
    button.add-btn:hover { background: rgba(79, 124, 255, 0.25); }
    button.add-btn:active { transform: translateY(1px); }

    .meta { margin-top: 6px; font-size: 12px; color: var(--muted); min-height: 18px; }

    .log { margin-top: 26px; background: linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%); border: 1px solid rgba(255,255,255,0.06); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
    .log-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.06); }
    .log-header h3 { margin: 0; font-size: 15px; letter-spacing: 0.3px; }
    .controls { display: flex; gap: 8px; }
    .controls button { padding: 8px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: var(--text); cursor: pointer; font-size: 12px; }
    .controls button:hover { background: rgba(255,255,255,0.12); }

    table { width: 100%; border-collapse: collapse; font-size: 14px; table-layout: auto; }
    thead th { text-align: left; padding: 10px 14px; color: var(--muted); font-weight: 600; border-bottom: 1px solid rgba(255,255,255,0.06); white-space: nowrap; }
    tbody td { padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,0.06); vertical-align: middle; }
    tbody tr:last-child td { border-bottom: none; }
    .empty-row td { text-align: center; color: var(--muted); padding: 18px; }
    .date-row td { background: rgba(255,255,255,0.04); color: var(--accent-2); font-weight: 700; letter-spacing: .3px; }

    .row-actions { white-space: nowrap; text-align: right; }
    .icon-btn { border: none; background: transparent; color: var(--muted); cursor: pointer; font-size: 16px; line-height: 1; padding: 4px 6px; }
    .icon-btn:hover { color: var(--text); }
    .icon-danger:hover { color: var(--danger); }

    /* OLD pill (kept for History view) */
    .drug-pill {
      display: inline-flex; align-items: center; gap: 8px; padding: 4px 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.05);
      max-width: 100%;
    }
    .drug-pill .color-dot { width: 10px; height: 10px; border-radius: 999px; display: inline-block; }
    .drug-pill .name-text { white-space: normal; overflow-wrap: anywhere; }

    /* NEW subtle color chip for the log's Drug column */
    .drug-chip { display: inline-flex; align-items: center; gap: 8px; padding: 4px 10px; border-radius: 999px; font-weight: 600; max-width: 100%; white-space: normal; overflow: visible; text-overflow: clip; border: 1px solid rgba(255,255,255,0.12); flex-wrap: wrap; }
    .drug-chip > span:not(.dot) {
      min-width: 0;
      white-space: normal;
      overflow-wrap: anywhere;    /* allows breaks inside long names */
    }
    .drug-chip .dot { width: 10px; height: 10px; border-radius: 999px; flex: 0 0 10px; background: var(--dot, #8ea8ff); box-shadow: 0 0 0 1px rgba(0,0,0,0.15) inset; }

    .edit-input { width: 100%; }

    /* Snackbar */
    .snackbar { position: fixed; left: 50%; bottom: calc(24px + var(--safe-bottom)); transform: translateX(-50%);
      background: #151a35; color: var(--text); border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px; padding: 10px 14px; box-shadow: var(--shadow);
      display: none; gap: 12px; align-items: center; z-index: 1000; }
    .snackbar.show { display: inline-flex; }
    .snackbar .msg { font-size: 14px; color: var(--muted); }

    /* Confirmation Modal */
    .modal-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(6, 10, 30, 0.6); backdrop-filter: blur(2px); z-index: 1100; animation: fadeIn .15s ease forwards; }
    .modal-overlay.show { display: flex; }
    #confirm { z-index: 1200; }

    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
    @keyframes slideIn { from { opacity: 0; transform: translateY(8px) } to { opacity: 1; transform: translateY(0) } }

    .modal { width: min(92vw, 520px); max-height: 80vh; overflow: auto; background: linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%); border: 1px solid rgba(255,255,255,0.10); border-radius: 16px; box-shadow: var(--shadow); padding: 18px; animation: slideIn .18s ease forwards; }
    .modal h4 { margin: 0 0 6px; font-size: 16px; letter-spacing: .3px; }
    .modal p { margin: 0 0 14px; color: var(--muted); }
    .modal .actions { display: flex; gap: 8px; justify-content: flex-end; }

    .btn { padding: 10px 12px; border-radius: 10px; font-weight: 600; cursor: pointer; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: var(--text); }
    .btn:hover { background: rgba(255,255,255,0.12); }
    .btn-danger { background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.35); }
    .btn-danger:hover { background: rgba(239,68,68,0.25); }
    .btn-ghost { background: transparent; border-color: rgba(255,255,255,0.15); }

    /* History Floating Button */
    .history-fab { position: fixed; right: 16px; bottom: calc(16px + var(--safe-bottom)); min-width: 48px; height: 48px; padding: 0 14px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.08); color: var(--text); box-shadow: var(--shadow); display: inline-flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1050; font-weight: 700; }
    .history-fab:hover { background: rgba(255,255,255,0.14); }

    /* History modal styles */
    .history-list { display: grid; gap: 10px; }
    .history-item { display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; padding: 10px; border-radius: 12px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); }
    .history-status { font-size: 12px; padding: 4px 8px; border-radius: 999px; }
    .status-active { background: rgba(34,197,94,0.15); border: 1px solid rgba(34,197,94,0.35); }
    .status-removed { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.35); }

    /* Mobile optimizations */
    @media (max-width: 960px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 720px) {
      .container { padding: 16px; margin: 20px auto; }
      .grid { grid-template-columns: 1fr; gap: 12px; }
      .dose-grid { grid-template-columns: 1fr 120px auto; }
      .toolbar button { padding: 12px 14px; }
      .log-header { padding: 12px; }
      thead th, tbody td { padding: 8px 10px; }
      .name { margin-right: 0; }
      .log { overflow-x: hidden; }
      table { table-layout: fixed; width: 100%; }
      thead th { white-space: nowrap; }
      tbody td { white-space: normal; word-break: break-word; }
      /* Give the Drug column a little more space on mobile */
      thead th:nth-child(1), tbody td:nth-child(1) { width: 28%; }
      /* Keep Time tight and never wrapped */
      thead th:nth-child(4), tbody td:nth-child(4) { white-space: nowrap; width: 1%; }
      /* Compact actions column */
      thead th:nth-child(5) { width: 56px; }
    }

    /* Make the delete/actions area compact on very small screens without horizontal scroll */
    @media (max-width: 480px) {
      .log { overflow-x: hidden; }
      table { table-layout: fixed; }
      thead th:nth-child(4), tbody td:nth-child(4) { width: 1%; white-space: nowrap; }
      thead th:nth-child(5) { width: 56px; }
      .row-actions { position: sticky; right: 0; background: linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%); }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Drug Tracker</h1>
      <p>Track drug dosage and timing easily on any device.<a href="#" id="privacy-open" class="inline-link" aria-haspopup="dialog" aria-controls="privacy" role="button">Privacy Information</a></p>
    </header>

    <div class="toolbar">
      <button id="add-med">+ Add Drug</button>
    </div>

    <section class="grid" id="drug-grid" aria-label="Drug Inputs"></section>

    <section class="log" aria-label="Total Drug Intake">
      <div class="log-header">
        <h3>Total Drug Intake</h3>
        <div class="controls">
          <button id="clear-log" title="Clear all entries">Clear All</button>
        </div>
      </div>
      <table aria-describedby="A table of recorded drug intakes grouped by date. Columns: Drug, Total, Doses, Time.">
        <thead>
          <tr>
            <th scope="col">Drug</th>
            <th scope="col">Total</th>
            <th scope="col">Doses</th>
            <th scope="col">Time</th>
            <th scope="col" aria-label="Actions" style="width:72px"></th>
          </tr>
        </thead>
        <tbody id="log-body">
          <tr class="empty-row"><td colspan="5">No entries yet — add a dosage above to get started.</td></tr>
        </tbody>
      </table>
    </section>
  </div>

  <!-- Floating History Button -->
  <button id="open-history" class="history-fab" title="View history (includes removed)">
    View History
  </button>

  <!-- Snackbar -->
  <div id="snackbar" class="snackbar" role="status" aria-live="polite">
    <span class="msg" id="snackbar-msg">Removed.</span>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirm" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="confirm-title" style="display:none;">
    <div class="modal" role="document">
      <h4 id="confirm-title">Please confirm</h4>
      <p id="confirm-msg">Are you sure you want to proceed?</p>
      <div class="actions">
        <button class="btn btn-ghost" id="confirm-no" autofocus>No</button>
        <button class="btn btn-danger" id="confirm-yes">Yes</button>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div id="history" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="history-title" style="display:none;">
    <div class="modal" role="document">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <h4 id="history-title" style="margin:0;">History</h4>
        <div class="actions">
          <button class="btn btn-ghost" id="history-close">Close</button>
          <button class="btn btn-danger" id="history-clear">Clear History</button>
        </div>
      </div>
      <p>Shows all intakes, including those that were removed.</p>
      <div id="history-list" class="history-list"></div>
    </div>
  </div>

  <!-- Privacy Modal -->
  <div id="privacy" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="privacy-title" style="display:none;">
    <div class="modal" role="document">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <h4 id="privacy-title" style="margin:0;">Privacy Information</h4>
        <div class="actions">
          <button class="btn btn-ghost" id="privacy-close">Close</button>
        </div>
      </div>
      <div class="privacy-content">
        <p><em>Your data stays on your device.</em></p>
        <p>Everything you enter is saved only in your browser’s local storage.</p>
        <p>We do not send, upload, or store your entries anywhere else — not on a server, not in the cloud.</p>
        <p>To remove your data, use “Clear All” or “Clear History,” or clear your browser’s storage for this site.</p>
      </div>
    </div>
  </div>

  <script>
    // --- Utilities ---
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function timeStr(d) {
      try { return new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit' }).format(d); }
      catch { return d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}); }
    }

    function dateLabel(d) {
      try { return new Intl.DateTimeFormat(undefined, { weekday: 'long', year: 'numeric', month: 'short', day: '2-digit' }).format(d); }
      catch { return d.toDateString(); }
    }

    function dayKey(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function parseDosage(text) {
      const t = (text||'').trim();
      const t2 = t.replace(',', '.');
      const m = t2.match(/^([+-]?\d*\.?\d+)\s*([a-zA-Zµμ%][\wµμ%\/]*)?/);
      if (!m) return { value: null, unit: null };
      const value = parseFloat(m[1]);
      const unit = (m[2] || '').trim();
      if (!isFinite(value)) return { value: null, unit };
      return { value, unit };
    }

    function fmtNumber(n) {
      if (n == null || !isFinite(n)) return '';
      return (Math.round(n*1000)/1000).toString();
    }

    function uid(prefix='id') { return `${prefix}_${Math.random().toString(36).slice(2,9)}_${Date.now().toString(36)}`; }

    function formatAsDatetimeLocal(d) {
      const pad = (n) => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    // Canonical/normalized name key for grouping by drug name (case/space-insensitive)
    function nameKey(str) { return (str || '').toString().trim().toLowerCase(); }

    // Determine readable text color (black/white) against a given hex background
    function getContrastColor(hex) {
      const v = (hex || '').replace('#','');
      const r = parseInt(v.substring(0,2),16), g = parseInt(v.substring(2,4),16), b = parseInt(v.substring(4,6),16);
      const toLin = (c) => { const s = c/255; return s <= 0.04045 ? s/12.92 : Math.pow((s+0.055)/1.055, 2.4); };
      const L = 0.2126*toLin(r) + 0.7152*toLin(g) + 0.0722*toLin(b);
      return L > 0.5 ? '#000' : '#fff';
    }

    function hexToRgba(hex, a = 1) {
      const v = (hex || '').replace('#','');
      const r = parseInt(v.substring(0,2),16) || 0;
      const g = parseInt(v.substring(2,4),16) || 0;
      const b = parseInt(v.substring(4,6),16) || 0;
      return `rgba(${r},${g},${b},${a})`;
    }

    // --- Unit normalization & pluralization (slim) ---
    function normalizeUnit(unitRaw) {
      if (!unitRaw) return '';
      const raw = unitRaw.trim();
      const token = raw.toLowerCase();
      if (token === 'ml') return 'mL';
      if (token === 'l') return 'L';
      if (token === 'ug' || token === 'mcg' || token === 'µg') return 'µg';
      return raw.toLowerCase(); // canonical
    }

    const PLURALS = { pill: ['pill', 'pills'], tab: ['tab', 'tabs'], line: ['line', 'lines'], drop: ['drop', 'drops'], unit: ['unit', 'units'] };

    function displayValueUnit(value, unit) {
      if (!unit) return fmtNumber(value);
      const uCanon = normalizeUnit(unit);
      const p = PLURALS[uCanon];
      if (p) { const u = (value === 1) ? p[0] : p[1]; return `${fmtNumber(value)} ${u}`; }
      return `${fmtNumber(value)} ${uCanon}`;
    }

    // Units for dropdown (order requested)
    const UNIT_OPTIONS = [
      { value: 'mg', label: 'mg' },
      { value: 'g', label: 'g' },
      { value: 'µg', label: 'µg' },
      { value: 'pill', label: 'pill' },
      { value: 'tab', label: 'tab' },
      { value: 'line', label: 'line' },
      { value: 'unit', label: 'unit' },
      { value: 'ml', label: 'ml' },
      { value: 'l', label: 'l' },
      { value: 'drop', label: 'drop' }
    ];

    // Fixed 10-color palette across spectrum (defined BEFORE loadState)
    const palette = ['#ef4444','#f59e0b','#eab308','#84cc16','#22c55e','#10b981','#06b6d4','#3b82f6','#8b5cf6','#ec4899'];
    const paletteNames = ['Red','Orange','Yellow','Lime','Green','Teal','Cyan','Blue','Violet','Pink'];

    // --- State ---
    const initialState = { drugs: [], entries: [], history: [] };
    const STORAGE_KEY = 'med_tracker_v2_state';

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(initialState);
        const parsed = JSON.parse(raw);
        parsed.entries?.forEach(e => e.ts = new Date(e.ts));
        parsed.history?.forEach(h => { h.ts = new Date(h.ts); if (h.addedAt) h.addedAt = new Date(h.addedAt); if (h.removedAt) h.removedAt = new Date(h.removedAt); });
        if (!Array.isArray(parsed.drugs)) parsed.drugs = [];
        if (!Array.isArray(parsed.entries)) parsed.entries = [];
        if (!Array.isArray(parsed.history)) parsed.history = [];
        parsed.drugs.forEach((d, i) => { if (!d.color) d.color = palette[i % palette.length]; });
        return parsed;
      } catch { return structuredClone(initialState); }
    }

    let state = loadState();
    function saveState() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch {} }

    // Snackbar / toast
    const snackbar = $('#snackbar');
    const snackbarMsg = $('#snackbar-msg');
    let undoTimer = null;
    function showToast(message, duration=2500) {
      if (undoTimer) clearTimeout(undoTimer);
      snackbarMsg.textContent = message;
      snackbar.classList.add('show');
      undoTimer = setTimeout(() => { snackbar.classList.remove('show'); undoTimer = null; }, duration);
    }

    // Confirmation modal
    const confirmOverlay = $('#confirm');
    const confirmMsg = $('#confirm-msg');
    const btnYes = $('#confirm-yes');
    const btnNo = $('#confirm-no');
    let confirmResolver = null;
    let lastFocused = null;

    function openConfirm(message) {
      confirmMsg.textContent = message;
      lastFocused = document.activeElement;
      confirmOverlay.style.display = 'flex';
      confirmOverlay.classList.add('show');
      btnNo.focus();
      return new Promise((resolve) => { confirmResolver = resolve; });
    }
    function closeConfirm(result=false) {
      confirmOverlay.classList.remove('show');
      confirmOverlay.style.display = 'none';
      if (typeof confirmResolver === 'function') { const r = confirmResolver; confirmResolver = null; r(result); }
      if (lastFocused && typeof lastFocused.focus === 'function') lastFocused.focus();
    }
    btnYes.addEventListener('click', () => closeConfirm(true));
    btnNo.addEventListener('click', () => closeConfirm(false));
    confirmOverlay.addEventListener('click', (e) => { if (e.target === confirmOverlay) closeConfirm(false); });
    document.addEventListener('keydown', (e) => {
      if (confirmOverlay.classList.contains('show')) {
        if (e.key === 'Escape') { e.preventDefault(); closeConfirm(false); }
        if (e.key === 'Enter') { e.preventDefault(); closeConfirm(true); }
      }
    });

    // History modal
    const historyOverlay = $('#history');
    const historyListEl = $('#history-list');
    $('#open-history').addEventListener('click', () => openHistory());
    $('#history-close').addEventListener('click', () => closeHistory());
    $('#history-clear').addEventListener('click', async () => {
      const ok = await openConfirm('Are you sure you want to clear the entire history? This cannot be undone.');
      if (ok) { state.history = []; saveState(); renderHistory(); closeHistory(); showToast('History cleared.'); }
    });
    function openHistory() { renderHistory(); historyOverlay.style.display = 'flex'; historyOverlay.classList.add('show'); $('#history-close').focus(); }
    function closeHistory() { historyOverlay.classList.remove('show'); historyOverlay.style.display = 'none'; }
    historyOverlay.addEventListener('click', (e) => { if (e.target === historyOverlay) closeHistory(); });

    function renderHistory() {
      const h = [...state.history].sort((a,b) => b.ts - a.ts);
      if (!h.length) { historyListEl.innerHTML = '<div class="empty-row" style="text-align:center;color:var(--muted);padding:12px;">No history yet.</div>'; return; }
      historyListEl.innerHTML = '';
      for (const item of h) {
        const row = document.createElement('div');
        row.className = 'history-item';
        const pillBadge = document.createElement('div');
        pillBadge.className = 'drug-pill';
        const dot2 = document.createElement('span');
        dot2.className = 'color-dot';
        dot2.style.background = item.colorAtEntry || '#8ea8ff';
        const nameSpan = document.createElement('span');
        nameSpan.className = 'name-text';
        nameSpan.textContent = item.drugNameAtEntry || 'Drug';
        pillBadge.appendChild(dot2);
        pillBadge.appendChild(nameSpan);

        const info = document.createElement('div');
        info.innerHTML = `<div style="font-weight:600;">${item.dosageText || '—'}</div>
                          <div style="font-size:12px;color:var(--muted)">${dateLabel(item.ts)} • ${timeStr(item.ts)}</div>`;

        const status = document.createElement('div');
        status.className = 'history-status ' + (item.removed ? 'status-removed' : 'status-active');
        status.textContent = item.removed ? 'Removed' : 'Active';

        row.appendChild(pillBadge);
        row.appendChild(info);
        row.appendChild(status);
        historyListEl.appendChild(row);
      }
    }

    // --- Rendering ---
    const grid = $('#drug-grid');
    const logBody = $('#log-body');

    function render() { renderDrugs(); renderLog(); }

    function renderDrugs() {
      grid.innerHTML = '';
      state.drugs.forEach((drug, idx) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.id = drug.id;

        const strip = document.createElement('div');
        strip.className = 'color-strip';
        strip.style.background = drug.color || palette[idx % palette.length];
        card.appendChild(strip);

        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove';
        removeBtn.textContent = 'Remove';
        removeBtn.setAttribute('aria-label', `Remove ${drug.name}`);
        card.appendChild(removeBtn);

        const nameEl = document.createElement('h2');
        nameEl.className = 'name';
        nameEl.contentEditable = 'true';
        nameEl.spellcheck = false;
        nameEl.title = 'Click to edit name';
        nameEl.textContent = drug.name;
        nameEl.dataset.prev = drug.name;

        const nameErr = document.createElement('div');
        nameErr.className = 'name-error';
        nameErr.textContent = 'This name is already in use.';

        nameEl.addEventListener('focus', () => { nameEl.dataset.prev = drug.name; });
        nameEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); nameEl.blur(); } });
        nameEl.addEventListener('input', () => {
          const proposed = nameEl.textContent.trim();
          const dup = state.drugs.some(d => d.id !== drug.id && nameKey(d.name) === nameKey(proposed));
          if (dup) { nameEl.classList.add('invalid'); nameErr.style.display = 'block'; }
          else { nameEl.classList.remove('invalid'); nameErr.style.display = 'none'; }
        });
        nameEl.addEventListener('blur', () => {
          const proposed = nameEl.textContent.trim();
          const prev = nameEl.dataset.prev || drug.name;
          const isEmpty = proposed.length === 0;
          const dup = state.drugs.some(d => d.id !== drug.id && nameKey(d.name) === nameKey(proposed));
          if (isEmpty || dup) {
            nameEl.textContent = prev;
            nameEl.classList.remove('invalid');
            nameErr.style.display = dup ? 'block' : 'none';
            setTimeout(() => { nameErr.style.display = 'none'; }, 2000);
            return;
          }
          drug.name = proposed;
          saveState();
          render();
        });

        // Color picker
        const colorWrap = document.createElement('div');
        colorWrap.className = 'color-picker';
        const colorLabel = document.createElement('label');
        colorLabel.textContent = 'Color:';

        const colorBtn = document.createElement('button');
        colorBtn.type = 'button';
        colorBtn.className = 'color-select-btn';
        const current = drug.color || palette[idx % palette.length];
        colorBtn.style.setProperty('--swatch', current);
        colorBtn.innerHTML = `<span class="swatch"></span><span class="label">${paletteNames[palette.indexOf(current)] || 'Color'}</span>`;
        colorBtn.setAttribute('aria-haspopup', 'listbox');
        colorBtn.setAttribute('aria-expanded', 'false');

        const menu = document.createElement('div');
        menu.className = 'color-menu';
        menu.setAttribute('role', 'listbox');

        palette.forEach((hex, i) => {
          const opt = document.createElement('div');
          opt.className = 'color-option';
          opt.setAttribute('role', 'option');
          opt.dataset.value = hex;
          opt.innerHTML = `<span class="swatch" style="--swatch:${hex}"></span><span class="label">${paletteNames[i]}</span>`;
          if (hex === current) opt.setAttribute('aria-selected', 'true');
          let picked = false; // guard against double-fire (pointerup + click)
          function onPick(ev) {
            if (picked) return;
            picked = true;
            ev?.stopPropagation?.();   // don't let the tap bubble and close before we handle it
            ev?.preventDefault?.();    // avoid stray default behaviors
          
            drug.color = hex;
            colorBtn.style.setProperty('--swatch', hex);
            colorBtn.querySelector('.label').textContent = paletteNames[i];
            saveState();
            render();
            colorWrap.classList.remove('open');
            colorBtn.setAttribute('aria-expanded', 'false');
          }
          
          opt.addEventListener('pointerup', onPick); // fires immediately on touch release
          opt.addEventListener('click', onPick);     // desktop & fallback
          menu.appendChild(opt);
        });

        colorBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const isOpen = colorWrap.classList.toggle('open');
          colorBtn.setAttribute('aria-expanded', String(isOpen));
        });

        colorWrap.appendChild(colorLabel);
        colorWrap.appendChild(colorBtn);
        colorWrap.appendChild(menu);

        const nameRow = document.createElement('div');
        nameRow.className = 'name-row';
        nameRow.appendChild(nameEl);

        // Dose UI: numeric + unit dropdown + Add button
        const doseRow = document.createElement('div');
        doseRow.className = 'dose-grid';

        const numInput = document.createElement('input');
        numInput.type = 'number';
        numInput.step = 'any';
        numInput.placeholder = 'Amount';
        numInput.min = '0';
        numInput.setAttribute('inputmode', 'decimal');
        numInput.setAttribute('aria-label', `Amount for ${drug.name}`);

        const unitSelect = document.createElement('select');
        unitSelect.setAttribute('aria-label', `Unit for ${drug.name}`);
        for (const u of UNIT_OPTIONS) {
          const opt = document.createElement('option');
          opt.value = u.value; opt.textContent = u.label; unitSelect.appendChild(opt);
        }
        unitSelect.value = drug.lastUnit || 'mg'; // remember last used unit per drug

        const addBtn = document.createElement('button');
        addBtn.className = 'add-btn';
        addBtn.textContent = 'Add';
        addBtn.addEventListener('click', () => { addEntryStandard(drug.id, drug.name, numInput, unitSelect, drug.color); });

        doseRow.appendChild(numInput);
        doseRow.appendChild(unitSelect);
        doseRow.appendChild(addBtn);

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.id = `meta-${drug.id}`;
        meta.textContent = totalsForDrugLabel(drug.id);

        card.appendChild(nameRow);
        card.appendChild(colorWrap);
        card.appendChild(doseRow);
        card.appendChild(meta);

        numInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addBtn.click(); } });

        removeBtn.addEventListener('click', async () => {
          const labelText = drug?.name ? `the category "${drug.name}"` : 'this category';
          const ok = await openConfirm(`Are you sure you want to remove ${labelText}?`);
          if (ok) { removeDrug(drug.id); showToast('Category removed.'); }
        });

        grid.appendChild(card);
      });
    }

    document.addEventListener('click', () => { $$('.color-picker.open').forEach(el => el.classList.remove('open')); });

    function renderLog() {
      const entries = [...state.entries].sort((a,b) => b.ts - a.ts);
      logBody.innerHTML = '';
      if (!entries.length) {
        logBody.innerHTML = '<tr class="empty-row"><td colspan="5">No entries yet — add a dosage above to get started.</td></tr>';
        return;
      }

      // running totals across ALL days
      const totalsByEntryGlobal = new Map();
      const sumsByNameGlobal = new Map();
      const ascAll = [...state.entries].sort((a,b)=> a.ts - b.ts || (a.id > b.id ? 1 : -1));
      for (const e of ascAll) {
        const currentName = lookupDrugName(e.drugId) || e.drugNameAtEntry || 'Drug';
        const nKey = nameKey(currentName);
        const unitNorm = normalizeUnit(e.unit);
        if (!sumsByNameGlobal.has(nKey)) sumsByNameGlobal.set(nKey, new Map());
        const uMap = sumsByNameGlobal.get(nKey);
        if (e.value != null && isFinite(e.value)) { uMap.set(unitNorm, (uMap.get(unitNorm) || 0) + e.value); }
        const parts = [];
        for (const [u,sum] of uMap.entries()) { if (!isFinite(sum)) continue; parts.push(displayValueUnit(sum, u)); }
        totalsByEntryGlobal.set(e.id, parts.length ? parts.join(' • ') : '—');
      }

      // Group by date
      const groups = {};
      for (const e of entries) { const k = dayKey(e.ts); (groups[k] ||= []).push(e); }
      const dayKeys = Object.keys(groups).sort((a,b) => (a<b?1:-1));

      for (const dk of dayKeys) {
        const d = new Date(dk + 'T00:00:00');
        const trDate = document.createElement('tr');
        trDate.className = 'date-row';
        const td = document.createElement('td');
        td.colSpan = 5; td.textContent = dateLabel(d); trDate.appendChild(td); logBody.appendChild(trDate);

        const dayEntries = groups[dk];
        const desc = [...dayEntries].sort((a,b)=> b.ts - a.ts);
        for (const e of desc) {
          const tr = document.createElement('tr');
          tr.dataset.entryId = e.id;

          // Drug cell with subtle color chip background + dot
          const tdDrug = document.createElement('td');
          const chip = document.createElement('span');
          chip.className = 'drug-chip';
          const bg = colorForEntry(e) || '#8ea8ff';
          const tint = hexToRgba(bg, 0.18);
          const border = hexToRgba(bg, 0.35);
          chip.style.background = tint;
          chip.style.borderColor = border;
          // chip text color stays default for consistency with dark theme
          const nameSpan = document.createElement('span');
          nameSpan.textContent = lookupDrugName(e.drugId) || e.drugNameAtEntry || 'Drug';
          chip.appendChild(nameSpan);
          tdDrug.appendChild(chip);

          const tdTotal = document.createElement('td');
          tdTotal.textContent = totalsByEntryGlobal.get(e.id) || '—';

          const tdDose = document.createElement('td');
          const tdTimeCell = document.createElement('td');

          if (editingId === e.id) {
            // amount (number) + unit (dropdown), just like add UI
            const amountInput = document.createElement('input');
            amountInput.type = 'number';
            amountInput.step = 'any';
            amountInput.min = '0';
            amountInput.className = 'edit-input';
            amountInput.id = `edit-num-${e.id}`;
            amountInput.value = (e.value != null && isFinite(e.value)) ? e.value : '';
            amountInput.setAttribute('inputmode', 'decimal');
            amountInput.setAttribute('aria-label', 'Amount');

            const unitSelect = document.createElement('select');
            unitSelect.id = `edit-unit-${e.id}`;
            unitSelect.setAttribute('aria-label', 'Unit');
            for (const u of UNIT_OPTIONS) { const opt = document.createElement('option'); opt.value = u.value; opt.textContent = u.label; unitSelect.appendChild(opt); }
            unitSelect.value = e.unitRaw || e.unit || 'mg';

            const timeInput = document.createElement('input');
            timeInput.type = 'datetime-local';
            timeInput.id = `edit-time-${e.id}`;
            timeInput.value = formatAsDatetimeLocal(e.ts);

            const enterSave = (ev) => { if (ev.key === 'Enter') { ev.preventDefault(); saveEdit(e.id); } };
            amountInput.addEventListener('keydown', enterSave);
            unitSelect.addEventListener('keydown', enterSave);
            timeInput.addEventListener('keydown', enterSave);

            // Put number + unit into the Doses cell
            const amtWrap = document.createElement('div');
            amtWrap.style.display = 'grid';
            amtWrap.style.gridTemplateColumns = '1fr 120px';
            amtWrap.style.gap = '8px';
            amtWrap.appendChild(amountInput);
            amtWrap.appendChild(unitSelect);
            tdDose.appendChild(amtWrap);
            tdTimeCell.appendChild(timeInput);
          } else {
            tdDose.textContent = e.dosageText;
            tdTimeCell.textContent = timeStr(e.ts);
          }

          const tdActions = document.createElement('td');
          tdActions.className = 'row-actions';

          if (editingId === e.id) {
            const saveBtn = document.createElement('button');
            saveBtn.className = 'icon-btn';
            saveBtn.textContent = '✔';
            saveBtn.title = 'Save';
            saveBtn.dataset.action = 'save-edit';
            saveBtn.dataset.entryId = e.id;

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'icon-btn';
            cancelBtn.textContent = '✕';
            cancelBtn.title = 'Cancel';
            cancelBtn.dataset.action = 'cancel-edit';
            cancelBtn.dataset.entryId = e.id;

            tdActions.appendChild(saveBtn);
            tdActions.appendChild(cancelBtn);
          } else {
            const editBtn = document.createElement('button');
            editBtn.className = 'icon-btn';
            editBtn.textContent = '✎';
            editBtn.title = 'Edit';
            editBtn.dataset.action = 'edit-entry';
            editBtn.dataset.entryId = e.id;

            const delBtn = document.createElement('button');
            delBtn.className = 'icon-btn icon-danger';
            delBtn.textContent = '×';
            delBtn.title = 'Remove this entry';
            delBtn.dataset.action = 'remove-entry';
            delBtn.dataset.entryId = e.id;

            tdActions.appendChild(editBtn);
            tdActions.appendChild(delBtn);
          }

          tr.appendChild(tdDrug);
          tr.appendChild(tdTotal);
          tr.appendChild(tdDose);
          tr.appendChild(tdTimeCell);
          tr.appendChild(tdActions);
          logBody.appendChild(tr);
        }
      }

      // Update per-card totals (ALL TIME)
      state.drugs.forEach(d => { const meta = document.getElementById(`meta-${d.id}`); if (meta) meta.textContent = totalsForDrugLabel(d.id); });
    }

    function lookupDrugName(id) { return state.drugs.find(d => d.id === id)?.name || null; }
    function lookupDrugColor(id) { return state.drugs.find(d => d.id === id)?.color || null; }
    function colorForEntry(e) {
      return lookupDrugColor(e.drugId) || colorForName(lookupDrugName(e.drugId) || e.drugNameAtEntry);
    }
    function colorForName(name) {
      if (!name) return null;
      const live = state.drugs.find(d => nameKey(d.name) === nameKey(name));
      if (live) return live.color;
      for (let i = state.history.length - 1; i >= 0; i--) { const h = state.history[i]; if (nameKey(h.drugNameAtEntry) === nameKey(name)) return h.colorAtEntry; }
      return null;
    }

    function totalsForDrugLabel(drugId) {
      const drug = state.drugs.find(d => d.id === drugId);
      if (!drug) return 'Total: —';
      const nKey = nameKey(drug.name);
      const units = new Map();
      for (const e of state.entries) {
        const entryNameKey = nameKey(e.drugNameAtEntry || lookupDrugName(e.drugId));
        if (entryNameKey !== nKey) continue;
        if (e.value == null || !isFinite(e.value)) continue;
        const u = normalizeUnit(e.unit || '');
        units.set(u, (units.get(u) || 0) + e.value);
      }
      if (!units.size) return 'Total: —';
      const parts = []; for (const [unit, sum] of units.entries()) { parts.push(displayValueUnit(sum, unit)); }
      return `Total: ${parts.join(' • ')}`;
    }

    // --- Add entries (standard only) ---
    function addEntryStandard(drugId, currentDrugName, numInput, unitSelect, colorAtEntry) {
      const raw = numInput.value;
      const value = parseFloat(raw);
      if (!raw || !isFinite(value) || value <= 0) {
        showToast('Enter a positive amount.');
        numInput.focus();
        numInput.style.boxShadow = '0 0 0 4px rgba(239, 68, 68, 0.35)';
        setTimeout(() => (numInput.style.boxShadow = ''), 300);
        return;
      }

      const unitRaw = unitSelect.value;
      const unitNorm = normalizeUnit(unitRaw);
      const ts = new Date();
      const dosageText = displayValueUnit(value, unitRaw);
      const entry = { id: uid('e'), ts, drugId, drugNameAtEntry: currentDrugName, dosageText, value, unit: unitNorm, unitRaw };
      state.entries.push(entry);

      // Remember last unit per drug
      const drug = state.drugs.find(d => d.id === drugId);
      if (drug) { drug.lastUnit = unitRaw; }

      // History
      state.history.push({ id: entry.id, ts: entry.ts, drugNameAtEntry: entry.drugNameAtEntry, dosageText, value, unit: unitNorm, colorAtEntry, addedAt: new Date(), removed: false, removedAt: null });
      saveState();
      numInput.value = '';
      render();
      numInput.focus();
    }

    function removeDrug(drugId) { const idx = state.drugs.findIndex(d => d.id === drugId); if (idx < 0) return; state.drugs.splice(idx, 1); saveState(); render(); }

    function removeEntry(entryId) {
      const idx = state.entries.findIndex(e => e.id === entryId);
      if (idx < 0) return;
      state.entries.splice(idx, 1);
      const h = state.history.find(x => x.id === entryId);
      if (h) { h.removed = true; h.removedAt = new Date(); }
      saveState();
      render();
    }

    function startEdit(entryId) { editingId = entryId; render(); const inp = document.getElementById(`edit-num-${entryId}`); if (inp) inp.focus(); }

    function saveEdit(entryId) {
      const amountEl = document.getElementById(`edit-num-${entryId}`);
      const unitEl = document.getElementById(`edit-unit-${entryId}`);
      const timeEl = document.getElementById(`edit-time-${entryId}`);
      const e = state.entries.find(x => x.id === entryId);
      if (!e || !amountEl || !unitEl || !timeEl) return;

      const amountRaw = amountEl.value;
      const value = parseFloat(amountRaw);
      if (!amountRaw || !isFinite(value) || value <= 0) {
        showToast('Enter a positive amount.');
        amountEl.focus();
        amountEl.style.boxShadow = '0 0 0 4px rgba(239, 68, 68, 0.35)';
        setTimeout(() => (amountEl.style.boxShadow = ''), 400);
        return;
      }
      const unitRaw = unitEl.value;

      e.value = value;
      e.unit = normalizeUnit(unitRaw);
      e.unitRaw = unitRaw;
      e.dosageText = displayValueUnit(value, unitRaw);
      if (timeEl.value) e.ts = new Date(timeEl.value);

      // update last unit on the live drug as well
      const d = state.drugs.find(d => d.id === e.drugId);
      if (d) d.lastUnit = unitRaw;

      editingId = null;
      saveState();
      render();
    }

    function cancelEdit() { editingId = null; render(); }

    let editingId = null; // entry currently being edited

    // --- Event delegation ---
    document.addEventListener('click', async (e) => {
      if (e.target && e.target.id === 'clear-log') {
        if (!state.entries.length) return;
        const ok = await openConfirm('Are you sure you want to clear all entries?');
        if (ok) {
          const ids = state.entries.map(x => x.id);
          for (const id of ids) { const h = state.history.find(x => x.id === id); if (h && !h.removed) { h.removed = true; h.removedAt = new Date(); } }
          state.entries = [];
          saveState();
          render();
          showToast('All entries cleared.');
        }
      }

      if (e.target && e.target.id === 'add-med') {
        let i = state.drugs.length + 1; let base = 'Drug '; let candidate = base + i; const names = new Set(state.drugs.map(d => nameKey(d.name)));
        while (names.has(nameKey(candidate))) { i++; candidate = base + i; }
        const color = palette[state.drugs.length % palette.length];
        state.drugs.push({ id: uid('drug'), name: candidate, color });
        saveState();
        render();
      }

      const actionBtn = e.target.closest('[data-action]');
      if (actionBtn) {
        const action = actionBtn.dataset.action;
        const id = actionBtn.dataset.entryId;
        if (action === 'remove-entry') { const ok = await openConfirm('Are you sure you want to remove this entry?'); if (ok) { removeEntry(id); showToast('Entry removed.'); } }
        if (action === 'edit-entry') startEdit(id);
        if (action === 'save-edit') saveEdit(id);
        if (action === 'cancel-edit') cancelEdit();
      }
    });

    // Privacy modal controls
    const privacyOverlay = $('#privacy');
    const privacyOpen = $('#privacy-open');
    const privacyClose = $('#privacy-close');
    privacyOpen.addEventListener('click', (e) => {
      e.preventDefault();
      privacyOverlay.style.display = 'flex';
      privacyOverlay.classList.add('show');
      privacyClose.focus();
    });
    privacyClose.addEventListener('click', () => { privacyOverlay.classList.remove('show'); privacyOverlay.style.display='none'; });
    privacyOverlay.addEventListener('click', (e) => { if (e.target === privacyOverlay) { privacyOverlay.classList.remove('show'); privacyOverlay.style.display='none'; } });
    document.addEventListener('keydown', (e) => {
      if (privacyOverlay.classList.contains('show') && e.key === 'Escape') {
        e.preventDefault();
        privacyOverlay.classList.remove('show');
        privacyOverlay.style.display='none';
      }
    });

    // Initial render
    render();
  </script>
</body>
</html>
